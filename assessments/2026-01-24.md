# Trueflow Assessment (2026-01-24)

## Repository Context
- CLI entrypoint and command routing live in `trueflow/src/main.rs` with commands: diff, review, mark, sync, check, scan, inspect, feedback, tui.
- Content model is `Block` + `FileState` in `trueflow/src/block.rs` and directory scanning in `trueflow/src/scanner.rs`.
- Semantic splitting uses tree-sitter for code and pulldown-cmark for Markdown in `trueflow/src/block_splitter.rs`.
- Sub-block splitting for implicit approval lives in `trueflow/src/sub_splitter.rs`.
- Review storage is append-only JSONL at `.trueflow/reviews.jsonl` via `trueflow/src/store.rs`.
- Sync pushes the review store to `trueflow-db` via `trueflow/src/commands/sync.rs`.
- Diff mode computes hunk-level fingerprints in `trueflow/src/diff_logic.rs`.
- E2E/integration tests are in `trueflow/tests/*`.

## Design Assessment
Strengths:
- Clear core idea: content-addressed blocks, semantic splitting, and git-backed review storage align well.
- Review metadata is structured and extensible (identity, note, tags).
- Good baseline test coverage for CLI flows.

Key Gaps:
- Two identity systems (block hashes vs diff fingerprints) do not interoperate, which can lead to inconsistent review outcomes.
- The file hash is a linear hash of block hashes, not a true Merkle tree (no subtree proofs, no incremental hashing).
- The design doc calls for whitespace normalization, but hashing is currently raw content.
- JSONL is great for v1, but needs compaction/indexing and corruption handling for long-term correctness.

## Bug / Correctness Risks (with planned tests)
- Optimizer import merge changes content and hashes by inserting extra newlines.
- Diff mode's `new_content` is not the post-hunk content; it only includes added lines.
- Review filtering ignores `check` semantics in one path and respects it in another.
- Review status uses file order instead of timestamp ordering in review mode.
- Block kind casing is inconsistent (Gap/gap/Imports), making exclusion fragile.
- Scanner aborts on a single unreadable directory entry.
- FileStore root detection can create `.trueflow` in a subdir.
- Diff base is `main..HEAD` instead of merge-base, causing unrelated changes to appear.
- Feedback XML is invalid if content contains `]]>`.

## Roadmap
Phase 0 - Correctness and consistency:
- Unify identity: map diff fingerprints to block hashes or move diff logic to block-level changes.
- Fix optimizer to preserve exact source content.
- Enforce a single block kind casing or typed enum with serde mapping.
- Make review status deterministic (timestamp order).
- Use merge-base for diff base.

Phase 1 - Resilience and storage:
- Anchor `.trueflow` at repo root; avoid subdir DBs.
- Add JSONL compaction and indexing; skip invalid lines gracefully.
- Atomic writes + fsync for DB updates.

Phase 2 - Performance:
- Cache scan results; avoid re-reading files unchanged.
- Parallelize scanning with a controlled worker pool.
- Honor `.gitignore` and add `.trueflowignore`.

Phase 3 - Product and UX:
- Coverage/stats command.
- Sub-block UI support in CLI/TUI/Emacs.
- Signature verification + trust policies.

## Long-Term Storage Note
- Keep JSONL now for simplicity and git-merge friendliness.
- Evaluate sled or SQLite later for indexing, querying, and compaction with a clean export/import path.

## Concrete Execution Plan
1. Add regression tests for each known correctness risk (E2E or integration-level).
2. Fix each failing test in sequence (optimizer merge, diff new content, review semantics, scan resilience, file store root, merge-base diffing, XML CDATA escaping).
3. Refactor types: introduce `BlockKind` and `Verdict` enums, wire them through CLI and storage.
4. Store `Language` in `FileState` and remove redundant file analysis in review/inspect.
5. Consolidate hashing utilities in `hashing.rs` and remove duplicates.
6. Run the test suite and tighten any lingering warnings or formatting issues.
